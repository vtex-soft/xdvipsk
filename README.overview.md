# Overview

## *xdvipsk*: extended dvips (`TeXLive 2025`)

It has a few base extensions:
* one allows flexible inclusion of bitmap images
* another extension solves a quite long-standing task &ndash; adds `OpenType` font support to `dvips`
* accepts font map `\special` commands with prefixes `mapfile` and `mapline` 
* extends with `Lua` callbacks for `specials` (prescan, scan), `after prescan`, `drawchar`,
  `drawrule`, `stack`, `dvips exit`
* `ToUnicode CMaps` support through adding `GlyphNames2Unicode` dictionary for `Type 1` and `OpenType` fonts
* accepts glyph names to unicode `\special` commands with prefixes `g2umapfile` and `g2umapline`
* accepts `GlyphNames2Unicode` dictionary directly from `<fontfilename>.g2u` file
* accepts glyph names to unicode lua table directly from `<fontfilename>.lua` file
* supports `DVI` `OpenType` font `GID` encoding with appropriate mapline and activated by  
  `\special{vtex:settings.xdvipsk.opentype={enc=gid}}`
* the program ignores the content of `\special` commands with unknown prefixes

The experimental `GID` encoding of the `DVI` file means character codes, corresponding to internal glyph indices of the `OpenType` font. It doesn't require additional encoding for the resulting `PostScript` file. The encoding needs modified `luatex` kernel or new `luaotfload` driver.  
In contrary, default `TeX` charcode encoded files use internal `TeX` character mapping and need additional encoding in case of `OpenType` fonts &ndash; through unicode maps generated by `luafonts` package.

*xdvipsk* goes `LuaTeX` way in `OpenType` font management:  
> works on `DVI` files compiled by `LuaTeX` and expects to find the necessary `Unicode` map files,
> obtained as by-products of the compilation. The provision of the map files is ensured
> by a special `(Lua)LaTeX` package `luafonts`.

The extended `dvips` now accepts `BMP`, `PCX`, `TIFF`, `JPEG` and `PNG` formats and is able to perform the same actions as with `EPS` images:  
- scaling, rotating, trim, viewport

The `xdvispk.def` (extended `dvips.def`) driver for graphics package does not yet implement the operations of clipping, trimming and viewport.

`xdvipsk` needs information about `OpenType` fonts used in `DVI` files in the form of `Unicode` map files.  
These are produced by `dvilualatex` using a special `(Lua)LaTeX` package `luafonts` (see below more details about the workflow).

`GlyphNames2Unicode` dictionaries are used to enable correct unicode-based search in `PDF`.  
It seems that `GhostScript` and `Adobe Acrobat` use this dictionary to create `ToUnicode CMaps` (at least for now).

### Bitmap inclusion

The extension for bitmap images does not require changes to the user-level syntax.  
The `LaTeX` command `\includegraphics` should work as described in the documentation of packages `graphics` and `graphicx`.
  
That is, after inclusion in the preamble of either
```latex
    \usepackage[*driver*]{graphics}
or
    \usepackage[*driver*]{graphicx}
```
where the file `*driver*.def` contains all the necessary declarations and is registered in `graphics.sty`.

As `xdvipsk` accepts images in formats `BMP`, `JPEG`, `PCX`, `PNG` and `TIFF`, they should all be declared in the form of graphic inclusion rules in the driver file, most likely `xdvipsk.def`:
```latex
    \@namedef{Gin@rule@.tif}#1{{bmp}{.tif.bb}{#1}}
    \@namedef{Gin@rule@.tiff}#1{{bmp}{.tiff.bb}{#1}}
    \@namedef{Gin@rule@.jpeg}#1{{bmp}{.jpeg.bb}{#1}}
    \@namedef{Gin@rule@.jpg}#1{{bmp}{.jpg.bb}{#1}}
    \@namedef{Gin@rule@.png}#1{{bmp}{.png.bb}{#1}}
```

Several things for style and package authors to know:

- bitmap image file names are included in `DVI` files inside arguments of
  `\special` commands with prefix `em: graph` (the name has roots in the time of the EmTeX distribution)

- bitmaps can be of different color models: `BW`, `gray`, `RGB`, `CMYK`, indexed `RGB`

- for more precise image positioning `xdvipsk` inserts the `PostScript` `HiResBoundingBox` parameter


### `Type 1` font support

#### Remapping

The program accepts `\special` commands with prefixes:  
`mapfile` and `mapline` to supplement font mapping provided in `psfonts.map` tables.

*mapfile* is used for reading a font map file consisting of one or more font map lines. The name of the map file is given together with an optional leading modifier character (+).  
There is a companion special type *mapline* that allows to scan single map lines; its map line argument has the same syntax as the map lines from a map file.  
Both specials can be used concurrently. The operation mode is selected by an optional modifier character (+) in front. This modifier defines how the individual map lines are going to be handled, and how a collision between an already registered map entry and a newer one is resolved;  
either ignoring a later entry with a warning in case modifier charcter is given,  
or replacing an existing entry in case no modifier character is given.  
Here are examples: 

```
    \special{mapfile: +myfont.map}
    \special{mapline: +ptmri8r Times-Italic <8r.enc <ptmri8a.pfb}

     or 

    \special{mapfile: myfont.map}
    \special{mapline: ptmri8r Times-Italic <8r.enc <ptmri8a.pfb}
```

>`mapline` format in special for `OpenType` fonts is a bit different:

```
    \special{mapline: <TFMNAME><SPACE><SPACE><PSNAME><SPACE>"<TEXFONTNAME>"<SPACE>><FILENAME>
```

>or in case TTC:

```
    \special{mapline: <TFMNAME><SPACE><SPACE><PSNAME><SPACE>"<TEXFONTNAME>"<SPACE>><FILENAME>(<SUBFONT>)
```

>Example:

```
    \special{mapline: [lmroman10-regular]:+tlig;  LMRoman10-Regular "LMRoman10-Regular" >$SELFAUTOPARENT/texmf-dist/fonts/opentype/public/lm/lmroman10-regular.otf}
```

#### `Type 1` encoding using `GlyphNames2Unicode`

`GlyphNames2Unicode` is an undocumented dictionary which `Adobe PostScript` printer driver uses to communicate with `Adobe Distiller`. In this dictionary the keys are glyph names, the values are Unicode `UTF-16` codes of them.  
The dictionary is stored in the `FontInfo` dictionary under the key `GlyphNames2Unicode`. `Ghostscript` recognises it and uses to generate `ToUnicode CMaps` with `pdfwrite`.

To add `GlyphNames2Unicode` dictionary `xdvipsk` uses these sources:

- compiled in executable `Lua` table (`Build/source/texk/xdvipsk/glyphlist_table.lua`,  
  inherited and supplemented from the standard `Adobe` glyph list  
  `https://github.com/adobe-type-tools/agl-aglfn/blob/master/glyphlist.txt`)  
   and other lists from `TeXLive` distribution;

- from `kpse_cmap_format` available file: `<fontfilename>.g2u` (formated as `PostScript` dictionary);  

    `kpse_cmap_format` files are searched in `fonts/cmap` subfolders of the `TeX` installation tree branches,  
    specified by the environment variables `$TEXMFDIST`, `$TEXMFMAIN` or `$TEXMFLOCAL`.  
    The `<fontfilename>` should correspond to the file name of particular `Type 1` `.pfb` font.

    Example: `mtex.g2u`
    ```
    /GlyphNames2Unicode <<
       /parenleftbig <0028>
       /parenrightbig <0029>
       /bracketleftbig <005b>
       /bracketrightbig <005d>
       /braceleftbig <007b>
       /bracerightbig <007d>
       /parenleftbigg <0028>
       /parenrightbigg <0029>
       /bracketleftbigg <005b>
       /bracketrightbigg <005d>
       /parenleftBigg <0028>
       /parenrightBigg <0029>
       /bracketleftBigg <005b>
       /bracketrightBigg <005d>
       /bracketlefttp <23a7>
       /bracketrighttp <23a4>
       /bracketleftbt <23a9>
       /bracketrightbt <23a6>
       /bracketleftex <23a2>
       /bracketrightex <23a5>
       /summationtext <2211>
       /summationdisplay <2211>
       /hatwide <02c6>
       /hatwidest <02c6>
       /radicalBig <221a>
    >> def
    ```
    Multiple quadruplets are used for multicode glyphs or `UTF-16` encoding of high unicode values,  
    exceeding the 16 bit Universal Character Set (look `https://en.wikipedia.org/wiki/UTF-16` for details):
    ```
    /GlyphNames2Unicode <<
       /FFIsmall <006600660069>
       /Bmathdstruck <D835DD39>
    >> def
    ```

- referenced by special with prefix `g2umapfile` file which returns a `Lua` table;  

    Example:
    ```
        \special{g2umapfile=glyphtounicode.lua}
    ```
    File `glyphtounicode.lua`:
    ```
    return {
       ['A'] = { 0x0041 },
       ['AE'] = { 0x00C6 },
       ['AEacute'] = { 0x01FC },
       ['AEmacron'] = { 0x01E2 },
       ['AEsmall'] = { 0x00E6 },
       ['Aacute'] = { 0x00C1 },
       ['Aacutesmall'] = { 0x00E1 },
       ['Abreve'] = { 0x0102 },
       ['Abreveacute'] = { 0x1EAE },
       ['Abrevecyrillic'] = { 0x04D0 },
       ['Abrevedotbelow'] = { 0x1EB6 },
       ['pfb:cmr10/suppress'] = { 0xEB61 },
       ['pfb:mnsymbol10/Neswarrow'] = { 0x21D5, 0x20D5 },
       ['FFIsmall'] = { 0x0066, 0x0066, 0x0069 },
       ['Amathdstruck'] = { 0x1D538 },
       ['Bmathdstruck'] = { 0xD835, 0xDD39 },
       ['one.upper'] = { 0xE001 },
       ['f_f_i'] = { 0xFB03 },
       ['ffi'] = { 0xFB03 },
       ['uniEB61'] = { 0xEB61 },
       ['u1D53A'] = { 0x1D53A }
    }
    ```

    Table record keys with a prefix `pfb:<pfbname>/` are used to restrict unicode values for using with particular fonts only.  
    Font prefixes should correspond the real lowercased `.pfb` file name without an extension.

    High unicode values, exceeding 16 bit boundary, could be entered as both &ndash; either a single `UTF-32` value (`0x1D538`) or a pair of `UTF-16` surrogates (`0xD835, 0xDD39`).

    `Lua` unicode tables could be loaded automatically as well like the `.g2u` files &ndash; by naming them in correspondence with a `.pfb` file name (`cmr10.lua`, for example) and placing them in the `kpse_cmap_format` folders of the `TeX` installation tree.  
    When loading `.lua` unicode tables automatically, they are activated for specific `.pfb` font only &ndash; a `pfb:<pfbname>/` prefix is added for every entry of the `.lua` table.  
    When loading explicitly through the `g2umapfile` special, the overloaded unicode values are valid for all fonts.  
    For restriction to some particular `.pfb` font a prefix prior the `.lua` table file name could be used as well:

    ```
        \special{g2umapfile=pfb:cmr10/overload.lua}
    ```

- defined by special with prefix `g2umapline` for single char;
 
    Example:
    ```
        \special{g2umapline=suppress,EB61}
    ```
    for specific `Type 1` font only:
    ```
        \special{g2umapline=pfb:cmr10/suppress,EB61}
    ```
    multicode symbols:
    ```
        \special{g2umapline=FFIsmall,0066 0066 0069}
    ```
    high 32 bit codes:
    ```
        \special{g2umapline=Amathdstruck,1D538}
    ```
    high 32 bit values in `UTF-16` encoding:
    ```
        \special{g2umapline=Bmathdstruck,D835 DD39}
    ```

    To reuse existing `pdftex` primitive `pdfglyphtounicode` resources, following overload could be used:
    ```
        \def\pdfglyphtounicode#1#2{\special{g2umapline=#1,#2}}
        \input{glyphtounicode.tex}
    ```

Specials `g2umapfile`/`g2umapline` can be anywhere in `DVI` file.

#### `GlyphNames2Unicode` value setting rules for `Type 1` fonts 

Unicode values are searched in the `<fontfilename>.g2u` and `Lua` tables (precompiled/`g2umapline`/`g2umapfile`),  
applying following modifications to the glyph name until proper unicode value not from `Private Use Area` (`PUA`) is found, in following order of descending priority:

   a) `pfb:<pfbname>/<glyphname>` (records for particular font, `pfb:cmr10/suppress` for example)

   b) lookup by pure `<glyphname>`, applicable for all fonts 
      (searching for the glyph `suppress`, if `pfb:cmr10/suppress` not found or in `PUA`)

   c) on failure of the last step additional lookups take place for the glyph names:
   - searching by the glyph name with postfix after the dot skipped;
   - searching by multiple glyph names split on the delimiter `_` ;
   - searching by split ligatures `fi`, `fl`, `ff`, `ffi` and `ffl`;
   - scanning unicode value from glyph names with prefixes `uni` or `u`.


### `Opentype` font support

For correct work of `xdvipsk`, a number of files should be prepared.

`texcid.pro`

> `PostScript` header file used for inclusion of
> `OpenType` fonts in `PostScript` files.  It is an analogue of
> `texps.pro` that is used in case of `Type 1` fonts.

`luafonts.sty` 

> A `LaTeX` package, which is just an interface
> to `Lua` code generating two maps necessary for `xdvipsk`.
> It is loaded like any other `\LaTeX` package: `\usepackage{luafonts}`

To get the general picture, how process is organized, let us present the description of workflow involving the use of `xdvipsk`.


#### Running `xdvipsk`

1. Run `dvilualatex *article*.tex` where file
  `*article*.tex` includes the line `\usepackage{luafonts}`

    - Input:

        ```
            *article*.tex
            tex/luatex/luafonts/luafonts.sty
            tex/luatex/luafonts/luafonts.lua
            ...
        ```

    - Output:

        ```
            *article*.dvi
            .xdvipsk/*psname*.encodings.map
            ...
            .xdvipsk/*article*.opentype.map
        ```

2. Run `xdvipsk *article*.dvi`

    - Input: 

        ```
            *article*.dvi
            .xdvipsk/*psname*.encodings.map
            ...
            .xdvipsk/*article*.opentype.map
            texmf-dist/dvips/base/texcid.pro
            ...
        ```

    - Output:

        ```
            *article*.ps
        ```

3. Convert the `PostScript` file to `PDF` (using `Ghostscript` or `Adobe Acrobat`):

    - Input:

        ```
            *article*.ps
        ```

    - Output:

        ```
            *article*.pdf
        ```


#### Map files 

`OpenType` font information is extracted and saved for later use in map files.  
This information is in the form as used in the `luaotfload` package, except the changes described below.

##### `Opentype` map

The map `*article*.opentype.map` file generated by the package is analogous to the `psfonts.map` file,  
used for `Type 1` fonts, and contains information about `OpenType` fonts used in a particular article.  
The map is a list of lines with tab-separated fields.  
Keep in mind that in generated map files syntax is a bit different to be used in special.
```
    TFMNAME PSNAME TEXFONTNAME >FILENAME
```

- `TFMNAME`

    is a metric file name as written in the `DVI` file by `LuaTeX`, like

    ```
    FandolFang-Regular
    FandolFang-Regular:mode=node;script=latn;language=DFLT;+tlig;
    TeXGyreAdventor
    TeXGyreAdventor/B
    TeXGyreAdventor/BI
    TeXGyreAdventor/I
    TeXGyreAdventor:mode=node;script=latn;language=DFLT;+pnum;+onum;
    [lmroman10-bold]:+tlig;
    [lmroman10-italic]:+tlig;
    [lmroman10-regular]:+tlig;
    [Avenir.ttc](11):mode=node;script=DFLT;language=dflt;
    ```

- `PSNAME` 

    is a `PostScript` font name from `luaotfload` `Lua` tables, like

    ```
    FandolFang-Regular
    TeXGyreAdventor-Regular
    TeXGyreAdventor-Bold
    TeXGyreAdventor-BoldItalic
    TeXGyreAdventor-Italic
    TeXGyreAdventor-Regular
    LMRoman10-Bold
    LMRoman10-Italic
    LMRoman10-Regular
    ```

- `TEXFONTNAME`

    is a fullname from 'luaotfload' `Lua` tables, like

    ```
    FandolFang R
    TeXGyreAdventor-Regular
    TeXGyreAdventor-Bold
    TeXGyreAdventor-BoldItalic
    TeXGyreAdventor-Italic
    TeXGyreAdventor-Regular
    LMRoman10-Bold
    LMRoman10-Italic
    LMRoman10-Regular
    ```

- `FILENAME`

    is a font file name also found in `luaotfload` `Lua` tables and modified so that the file-path prefix,  
    corresponding to the actual TeX-tree branch used, is replaced by variable `$SELFAUTOPARENT` and `$SELFAUTOGRANDPARENT`:

    ```
    $SELFAUTOPARENT/texmf-dist/fonts/opentype/public/fandol/FandolFang-Regular.otf
    $SELFAUTOPARENT/texmf-dist/fonts/opentype/public/tex-gyre/texgyreadventor-regular.otf
    $SELFAUTOPARENT/texmf-dist/fonts/opentype/public/tex-gyre/texgyreadventor-bold.otf
    $SELFAUTOPARENT/texmf-dist/fonts/opentype/public/tex-gyre/texgyreadventor-bolditalic.otf
    $SELFAUTOPARENT/texmf-dist/fonts/opentype/public/tex-gyre/texgyreadventor-italic.otf
    $SELFAUTOPARENT/texmf-dist/fonts/opentype/public/tex-gyre/texgyreadventor-regular.otf
    $SELFAUTOPARENT/texmf-dist/fonts/opentype/public/lm/lmroman10-bold.otf
    $SELFAUTOPARENT/texmf-dist/fonts/opentype/public/lm/lmroman10-italic.otf
    $SELFAUTOPARENT/texmf-dist/fonts/opentype/public/lm/lmroman10-regular.otf

    ```

The current version of `luaotfload` operates with only one writable cache,  
which incorporates file paths specific to an OS, which is inconvenient in case of production environment  
which contains different operating systems and we wanted to organize things in a more flexible way.

##### Encodings maps

Another type of maps generated by `luafonts` stores information about characters.  
It consists of five columns
```
    <TeX charcode>,<OT font glyph index>,<unicode equivalent>,<glyph width>,<glyph height>

    59964,707,00AF,376832,365690.88
    59965,708,00AF,376832,414842.88
    59966,709,00200331,376832,0
    59967,710,0304,0,573440
    59968,711,02DA,569507.84,408944.64
    59969,712,0020030A0301,569507.84,543948.8
    59970,713,0020030A0301,569507.84,586547.2
    59971,714,030A,0,610140.16
    59972,715,02DC,376832,389283.84
```

##### `ToUnicode CMaps` and `GlyphNames2Unicode`

For encoding of `OpenType` fonts same dictionaries `GlyphNames2Unicode` of the font description sections in the `PostScript` file could be used.  
Instead of glyph names glyph indices `GID`s are used in `OpenType` fonts case:

    ```
    /GlyphNames2Unicode <<
      5 <0041>
      6 <0042>
      7 <0043>
      8 <0044>
      9 <0045>
      10 <0046>
      12 <0048>
      13 <0049>
      14 <004A>
      16 <004C>
      17 <004D>
      18 <004E>
      19 <004F>
      20 <0050>
      22 <0052>
      23 <0053>
      24 <0054>
      26 <0056>
      29 <0059>
      >> def
    ```

In contrast to `Type 1` fonts, `GlyphNames2Unicode` dictionaries for `OpenType` fonts are formed not from external or internal glyph name to unicode tables. Unicode maps `.xdvipsk/*.encodings.map` and `.otf` encodings are used instead.


##### `GlyphNames2Unicode` value setting rules for `OpenType` fonts

Unicode values searching sources, in descending priority order:

   a) `.xdvipsk/*.encodings.map` files (`TeX` charcode encoded files only);

   b) unicode values looked up from the `.otf` file;

   c) if the `.otf` codes are from `Private Use Area` (`PUA`),
      they are overwriten from `Lua` tables (precompiled/`g2umapline`/`g2umapfile`),
      according the `PostScript` names of the glyphs;

   d) on failure of the last step (glyph name record not found in the encoding tables or the code is in `PUA`)
      additional lookups take place for the glyph names:

      - searching by the glyph name with postfix after the dot skipped
        (for example, glyph `one` is searched in case of the unknown glyph `one.upper`);

      - glyph name is split to multiple names on the delimiter `_`
        (for example, glyph of the ligature `f_f_i` is partitioned to glyphs `f`, `f` and `i`,
        resulting in multiple code 0x0066, 0x0066, 0x0069);

      - glyph names of ligatures `fi`, `fl`, `ff`, `ffi` and `ffl` are split to multiple glyph names as well;

      - glyph names with prefixes `uni` or `u` are scanned for a hex code as the rest of the glyph name.

`Private Use Area` (`PUA`):
```
    (((ucode >= 0xE000) && (ucode < 0xF900)) ||
    ((ucode >= 0xF0000) && (ucode < 0xFFFFE)) ||
    ((ucode >= 0x100000) && (ucode < 0x10FFFE)))
```

Look for `Adobe` glyph name syntax specification for details:

`https://github.com/adobe-type-tools/agl-specification`


### `Lua` callbacks (experimental stuff)

`xdvipsk` reads `Lua` script file `xdvipsk.lua` if it is found by `kpse` and looks for these `Lua` functions:

- prescan_specials_callback(special, table)
> `special` - original special data, `table` with keys: `hh`, `vv`, `pagenum`

- scan_specials_callback(special, table)
> `special` - original special data, `table` with keys: `hh`, `vv`, `pagenum`

- after_prescan_callback(table)
> `table` with keys: `hpapersize`, `vpapersize`, `hoff`, `voff`, `actualdpi`, 
>                    `vactualdpi`, `num`, `den`, `mag`, `totalpages`

- after_drawchar_callback(table)
> `table` with keys: `charcode`, `cid`, `pixelwidth`, `rhh`, `rvv`, `dir`, `lastfont`
>                    `tounicode`

- after_drawrule_callback(table)
> `table` with keys: `hh`, `vv`, `dir`, `rw`, `rh`

- process_stack_callback(table)
> `table` with keys: `cmd`, `hh`, `vv`, `dir`

- dvips_exit_callback(table)
> `table` with keys: `exitcode`, `log_records_count`

Two functions: `prescan_specials_callback` and `scan_specials_callback` are used
for processing `dvi specials` in prescan and scan steps accordingly
before be processed by `xdvipsk` native mechanism.

Return values defines processing behaviour:

  - non empty string defines modified `dvi special` to be processed;

  - true value means processing original `dvi special` in default way;

  - empty string or false value means skipping `dvi special`.

Demo script file: `testdata/luacallbacks/xdvipsk.lua`

Default `Lua` script file can be changed by command line argument `-lua`  
or command `luascript` in `xdvipsk` config files.


### External libraries

- from `TeXLive` enviroment:

 ```
    kpathsea
    lua53
    freetype2
    libpng
    zlib
```
- from xdvipsk sources:

 ```
    jpeglib - version 9.2.0
    libtiff - version 4.7.0
 ```

`TeXLive` build environment is used to build executables for these architectures *Linux*, *macOS* and *Windows*.  
`Windows` binaries are cross compiled with `mingw`.

The current `xdvipsk` version is based on `dvips 2024.1`, `web2c + kpathsea 6.4.0/dev`, `TeXLive 2025/dev`.
